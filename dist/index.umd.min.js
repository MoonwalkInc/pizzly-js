!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).Pizzly=i()}(this,(function(){"use strict";class t{constructor(t,e,o,s){if(this.status=i.IDLE,!t)throw new Error("Couldn't connect. Missing argument: integration (string)");if(!window)throw new Error("Couldn't connect. The window object is undefined. Are you using connect from a browser?");this.integration=t,this.options=e,this.key=o,this.origin=s}trigger(){const t=this.toQueryString(this.key,this.options),o=new URL("/auth/"+this.integration+(t?"?"+t:""),this.origin).href;return new Promise((t,s)=>{var n;const r=e=>{if(this.status!==i.BUSY)return;if(e&&new URL(e.origin).origin!==new URL(this.origin).origin)return;if(this.status=i.DONE,!e){return s(new Error("Authorization cancelled. The user has likely interrupted the process by closing the modal."))}if(!e.data||!e.data.eventType){return s(new Error("Authorization failed. The authorization modal sent an unsupported MessageEvent."))}const{data:o}=e;return"AUTHORIZATION_SUCEEDED"===o.eventType?t(o.data):"AUTHORIZATION_FAILED"===o.eventType?s(o.data):void s(new Error("Authorization failed. Thatâ€™s all we know."))};if(window.addEventListener("message",r,!1),this.status=i.BUSY,null===(n=this.options)||void 0===n?void 0:n.navigateWithoutPopup)window.location.href=o;else{const t=new e(o);t.open(),t.addEventListener("close",r)}})}toQueryString(t,i){let e=[];if(t&&"string"==typeof t&&e.push("pizzly_pkey="+t),i&&"string"==typeof i.authId&&e.push("authId="+i.authId),i&&"string"==typeof i.setupId&&e.push("setupId="+i.setupId),i&&void 0!==i.params)for(const t in i.params){const o=i.params[t];"string"==typeof o&&e.push(`params[${t}]=${o}`)}return e.join("&")}}var i;!function(t){t[t.IDLE=0]="IDLE",t[t.BUSY=1]="BUSY",t[t.DONE=2]="DONE"}(i||(i={}));class e{constructor(t){this.width=500,this.height=600,this.url=t;const{left:i,top:e,computedWidth:o,computedHeight:s}=this.layout(this.width,this.height);this.features={width:o,height:s,top:e,left:i,scrollbars:"yes",resizable:"yes",status:"no",toolbar:"no",location:"no",copyhistory:"no",menubar:"no",directories:"no"}}layout(t,i){const e=window.screen.width,o=window.screen.height,s=e/2-t/2,n=o/2-i/2,r=Math.min(t,e),h=Math.min(i,o);return{left:Math.max(s,0),top:Math.max(n,0),computedWidth:r,computedHeight:h}}open(){const t=this.url,i=this.featuresToString();return this.modal=window.open(t,"",i),this.modal}addEventListener(t,i){if("close"!==t)return;if(!this.modal)return void i();const e=window.setInterval(()=>{this.modal&&!this.modal.closed||(i(),window.clearInterval(e))},100)}featuresToString(){const t=this.features,i=[];for(let e in t)i.push(e+"="+t[e]);return i.join(",")}}class o{constructor(t,i,e,s){this.options={},this.auth=t=>new o(this.integration,Object.assign(Object.assign({},this.options),{authId:t}),this.key,this.origin),this.setup=t=>new o(this.integration,Object.assign(Object.assign({},this.options),{setupId:t}),this.key,this.origin),this.get=(t,i)=>this.request("GET",t,i),this.head=(t,i)=>this.request("HEAD",t,i),this.post=(t,i)=>this.request("POST",t,i),this.put=(t,i)=>this.request("PUT",t,i),this.delete=(t,i)=>this.request("DELETE",t,i),this.patch=(t,i)=>this.request("PATCH",t,i),this.request=(t,i,e={})=>{if(e&&"object"!=typeof e)throw new Error('Unable to trigger API request. Request parameters should be an object in the form "{ headers: { "Foo": "bar" }, body: "My body" }');const o={"Pizzly-Auth-Id":this.options.authId,"Pizzly-Setup-Id":this.options.setupId};if(e&&e.headers)for(const t in e.headers)o["Pizzly-Proxy-"+t]=e.headers[t];const s=this.toURL(this.origin,"/proxy/"+this.integration,i,this.key,e.query);return(0,window.fetch)(s.toString(),{method:t,headers:this.cleanHeaders(o),body:e&&e.body})},this.integration=t,this.options=i,this.origin=s,this.key=e}connect(i){const e=Object.assign(Object.assign({},this.options),i||{});return new t(this.integration,e,this.key,this.origin).trigger()}toURL(t,i,e,o,s){const n=t=>t.replace(/^\//,""),r=t=>t.replace(/\/$/,""),h=[];h.push(r(t)),h.push(n(r(i))),h.push(n(e));const a=new URL(h.join("/"));return o&&a.searchParams.append("pizzly_pkey",o),s&&Object.keys(s).forEach(t=>a.searchParams.append(t,String(s[t]))),a}cleanHeaders(t){return Object.keys(t).reduce((i,e)=>(void 0!==t[e]&&(i[e]=t[e]),i),{})}}return class{constructor(t,i){if(this.key="",this.origin="",!window){throw new Error("Couldn't initialize Pizzly. The window object is undefined. Are you using Pizzly from a browser?")}if(t&&"string"==typeof t&&(this.key=t),i&&"string"==typeof i)this.origin=new URL(i).href;else if(i&&"object"==typeof i){const t=i.protocol||window.location.protocol,e=i.port||window.location.port||80,o=i.hostname||window.location.hostname;this.origin=new URL(t+"//"+o+":"+e).href}if(!this.origin){const i="object"==typeof t&&t.host;if(i)if(i.startsWith("http://")||i.startsWith("https://"))this.origin=new URL(i).href;else{const t=window.location.protocol;this.origin=new URL(t+"//"+i).href}else{const t=window.location.protocol,i=window.location.hostname,e=window.location.port||80,o=i+(80!==Number(e)?":"+e:"");this.origin=new URL(t+"//"+o).href}}if(!this.key){const i="object"==typeof t&&t.publishableKey;i&&(this.key=i)}return this}connect(i,e){return new t(i,e||{},this.key,this.origin).trigger()}integration(t,i){return new o(t,i||{},this.key,this.origin)}}}));